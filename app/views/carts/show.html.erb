<div class="container py-5">
  <h1 class="h3 mb-4">Tu carrito</h1>

  <% if @cart.blank? || @cart.line_items.empty? %>
    <div class="alert alert-info">Tu carrito est√° vac√≠o.</div>
    <%= link_to "Seguir comprando", products_path, class: "btn btn-outline-success" %>
  <% else %>
    <div class="row g-4">
      <div class="col-lg-8">
        <div class="card shadow-sm">
          <div class="table-responsive">
            <table class="table align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>Producto</th>
                  <th class="text-center" style="width: 140px;">Cantidad</th>
                  <th class="text-end">Precio</th>
                  <th class="text-end">Subtotal</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <% @cart.line_items.each do |item| %>
                  <tr>
                    <td>
                      <div class="d-flex align-items-center">
                        <%# Optional product image %>
                        <% if item.product.respond_to?(:image_url) && item.product.image_url.present? %>
                          <img src="<%= item.product.image_url %>" alt="<%= item.product.name %>" class="me-3" style="width:60px;height:60px;object-fit:cover;border-radius:8px;">
                        <% end %>
                        <div>
                          <strong><%= item.product.name %></strong>
                          <div class="text-muted small"><%= item.product.short_description if item.product.respond_to?(:short_description) %></div>
                        </div>
                      </div>
                    </td>

                    <td class="text-center">
                      <%= form_with url: cart_line_item_path(item), method: :patch, class: "d-inline-flex align-items-center justify-content-center gap-2", data: { turbo: false } do |f| %>
                        <%= f.number_field :quantity, value: item.quantity, min: 1, class: "form-control text-center", style: "width:80px" %>
                        <%= f.submit "Actualizar", class: "btn btn-sm btn-outline-secondary" %>
                      <% end %>
                    </td>

                    <td class="text-end"><%= number_to_currency(item.unit_price) %></td>
                    <td class="text-end"><%= number_to_currency(item.total_price) %></td>

                    <td class="text-end">
                      <%= button_to "Quitar", cart_line_item_path(item), method: :delete, form: { data: { turbo: false } }, class: "btn btn-sm btn-outline-danger" %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card mt-3 p-3">
          <%= form_with url: apply_coupon_cart_path, method: :post, class: "row g-2 align-items-center", data: { turbo: false } do |f| %>
            <div class="col-sm-6 col-md-4">
              <%= f.label :coupon_code, "C√≥digo de descuento", class: "form-label mb-0" %>
              <%= f.text_field :coupon_code, class: "form-control", placeholder: "OLIVA10" %>
            </div>
            <div class="col-auto">
              <%= f.submit "Aplicar", class: "btn btn-outline-success mt-3 mt-sm-0" %>
            </div>
          <% end %>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card p-4 shadow-sm">
          <h2 class="h5 mb-3">Resumen</h2>
          <ul class="list-unstyled mb-3">
            <li class="d-flex justify-content-between">
              <span>Subtotal</span>
              <strong><%= number_to_currency(@cart.subtotal) %></strong>
            </li>
            <li class="d-flex justify-content-between">
              <span>Env√≠o</span>
              <strong><%= @cart.shipping_amount ? number_to_currency(@cart.shipping_amount) : "Calculado en checkout" %></strong>
            </li>
            <% if @cart.discount_amount.to_f > 0 %>
              <li class="d-flex justify-content-between text-success">
                <span>Descuento</span>
                <strong>-<%= number_to_currency(@cart.discount_amount) %></strong>
              </li>
            <% end %>
            <hr>
            <li class="d-flex justify-content-between fs-5">
              <span>Total</span>
              <strong><%= number_to_currency(@cart.total) %></strong>
            </li>
          </ul>

          <%= link_to "Ir a pagar", checkout_path, class: "btn btn-success w-100 mb-2" %>
          <%= link_to "Seguir comprando", products_path, class: "btn btn-outline-secondary w-100" %>
        </div>

        <div class="card mt-3 p-3">
          <div class="d-flex align-items-start">
            <div class="me-2">ü´í</div>
            <div class="small">
              <strong>Oliva virgen extra</strong><br>
              Entrega r√°pida y env√≠os a todo Chile.
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>
