<div class="container py-5">
  <div class="mx-auto" style="max-width: 960px;">
    <div class="card shadow-sm">
      <div class="card-body p-4">

        <h1 class="h4 mb-4">Tu carrito</h1>

        <div class="table-responsive">
          <table class="table align-middle mb-3">
            <thead class="table-light">
              <tr>
                <th>Producto</th>
                <th class="text-nowrap">Tamaño</th>
                <th class="text-nowrap">Precio</th>
                <th style="width: 11rem;">Cantidad</th>
                <th class="text-end text-nowrap">Total</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <% subtotal = 0 %>

              <% Array(@cart_items).each do |ci| %>
                <% line_total = ci.quantity * ci.product_variant.price.to_f; subtotal += line_total %>
                <tr>
                  <td class="fw-medium"><%= ci.product_variant.product.name %></td>
                  <td><%= ci.product_variant.size %></td>
                  <td>$<%= number_with_delimiter(ci.product_variant.price) %></td>
                  <td>
                    <%= form_with model: ci, url: cart_item_path(ci), method: :patch, class: "d-flex gap-2", data: { turbo: false } do |f| %>
                      <%= f.number_field :quantity, min: 1, step: 1, class: "form-control", value: ci.quantity, required: true %>
                      <%= f.submit "OK", class: "btn btn-outline-secondary btn-sm" %>
                    <% end %>
                  </td>
                  <td class="text-end">$<%= number_with_delimiter(line_total.round) %></td>
                  <td class="text-end">
                    <%= button_to "Eliminar", ci, method: :delete,
                          class: "btn btn-outline-danger btn-sm",
                          form: { data: { turbo_confirm: "¿Eliminar este ítem?" } } %>
                  </td>
                </tr>
              <% end %>

              <% Array(@session_lines).each do |sl| %>
                <% subtotal += sl.line_total %>
                <tr>
                  <td class="fw-medium"><%= sl.product_name %></td>
                  <td><%= sl.size %></td>
                  <td>$<%= number_with_delimiter(sl.price) %></td>
                  <td>
                    <%= form_with url: cart_item_path(sl.id), method: :patch, class: "d-flex gap-2", data: { turbo: false } do |f| %>
                      <%= number_field_tag "cart_item[quantity]", sl.quantity, min: 1, step: 1, class: "form-control", required: true %>
                      <%= f.submit "OK", class: "btn btn-outline-secondary btn-sm" %>
                    <% end %>
                  </td>
                  <td class="text-end">$<%= number_with_delimiter(sl.line_total.round) %></td>
                  <td class="text-end">
                    <%= button_to "Eliminar", cart_item_path(sl.id), method: :delete,
                          class: "btn btn-outline-danger btn-sm",
                          form: { data: { turbo_confirm: "¿Eliminar este ítem?" } } %>
                  </td>
                </tr>
              <% end %>

              <tr>
                <th colspan="4" class="text-end">Subtotal</th>
                <th class="text-end">$<%= number_with_delimiter(subtotal.round) %></th>
                <th></th>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mt-3">
          <%= link_to "← Seguir comprando", products_path, class: "btn btn-outline-secondary" %>

          <% checkout_url = logged_in? ? orders_path : login_path %>
          <%= link_to "Ir a pagar", checkout_url, class: "btn btn-success px-4" %>
        </div>

        <% unless logged_in? %>
          <div class="alert alert-info mt-3 mb-0">
            Estás comprando como invitado. <%= link_to "Inicia sesión", login_path %> o
            <%= link_to "regístrate", register_path %> para guardar tu carrito.
          </div>
        <% end %>

      </div>
    </div>
  </div>
</div>
